#!/bin/bash -e

# Fail fast in production if secrets are missing
if [ "${RAILS_ENV}" = "production" ]; then
  if [ -z "${RAILS_MASTER_KEY}" ] && [ -z "${SECRET_KEY_BASE}" ] && [ ! -f "/rails/config/master.key" ]; then
    SECRET_KEY_BASE=$(ruby -e 'require "securerandom"; print SecureRandom.hex(64)')
    export SECRET_KEY_BASE
    echo "WARN: SECRET_KEY_BASE autogenerado para este contenedor (no recomendado en producciÃ³n real)." >&2
  fi
fi

# If running the rails server then create or migrate existing database
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  ./bin/rails db:prepare
fi

exec "${@}"
